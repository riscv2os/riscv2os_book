#### 3.4 RISC-V 的協同式多工系統

協同式多工（Cooperative Multitasking）是一種多任務處理技術，其中正在運行的任務必須在特定的時間點主動讓出控制權，以允許其他任務執行。這種方法相較於搶佔式多工（Preemptive Multitasking）更簡單，因為它不需要複雜的上下文切換機制，但對於設計和實現具有挑戰性，尤其是在嵌入式系統中。

##### 1. 協同式多工的基本概念

在協同式多工系統中，任務主動決定何時讓出控制權，這通常是透過以下方式實現的：

- **顯示讓渡**：任務在執行過程中，根據自己的需要主動調用讓渡函數，讓出CPU控制權，這樣其他任務便可以被調度。
- **基於事件的讓渡**：某些事件（如IO操作完成）發生時，任務可以主動讓渡控制權。

協同式多工的優點在於簡化了上下文切換，減少了系統開銷，缺點則在於某個任務如果不主動讓渡控制權，將導致系統其他任務無法執行，可能會造成不穩定的系統行為。

##### 2. RISC-V 中的協同式多工實現

在 RISC-V 嵌入式系統中實現協同式多工需要對任務管理和上下文切換進行一些基本設計。以下是協同式多工系統的實現步驟。

###### 2.1 定義任務控制塊（TCB）

每個任務的上下文信息需要在 TCB 中進行管理。TCB 中需要包含的字段可能有：

```c
typedef struct {
	uint32_t *sp;       // 堆疊指針
	uint32_t *pc;       // 程序計數器
	uint32_t status;    // 任務狀態
	void (*task_func)(); // 任務函數指針
} TCB;
```

###### 2.2 任務創建與管理

在協同式多工中，任務需要註冊到系統中，以便於調度和管理。這可以通過一個簡單的創建任務函數來實現：

```c
#define MAX_TASKS 10

TCB *task_list[MAX_TASKS];
int task_count = 0;

void create_task(void (*task_func)()) {
	if (task_count < MAX_TASKS) {
		TCB *tcb = (TCB *)malloc(sizeof(TCB));
		tcb->task_func = task_func;
		tcb->sp = (uint32_t *)malloc(STACK_SIZE); // 為堆疊分配空間
		tcb->status = 0; // 設置初始狀態
		task_list[task_count++] = tcb;
	}
}
```

###### 2.3 任務切換函數

協同式多工中的任務切換需要在任務結束時或主動讓渡時進行。在這裡，我們可以定義一個讓渡函數：

```c
void yield() {
	// 保存當前任務的上下文
	save_context(current_task);

	// 調度下一個任務
	scheduler();

	// 加載新任務的上下文
	load_context(current_task);
}
```

這裡的 `yield()` 函數可以在任務中被調用，以讓出控制權。 

###### 2.4 調度器的實現

協同式調度器的實現可以非常簡單，通常是基於循環調度的原則：

```c
void scheduler() {
	// 簡單的輪詢調度
	static int current_index = -1;
	current_index = (current_index + 1) % task_count;
	current_task = task_list[current_index];
}
```

這樣每次調用 `scheduler()` 時，將會返回下一個任務。

##### 3. 任務示例

以下是一個簡單的任務示例，展示如何使用協同式多工：

```c
void task1() {
	while (1) {
		// 執行任務1的邏輯
		// ...
		yield(); // 主動讓出控制權
	}
}

void task2() {
	while (1) {
		// 執行任務2的邏輯
		// ...
		yield(); // 主動讓出控制權
	}
}

// 在系統初始化時創建任務
create_task(task1);
create_task(task2);
```

在這個示例中，`task1` 和 `task2` 會持續運行並且在需要的時候主動讓出控制權。

##### 4. 優缺點

協同式多工的優點包括：

- **簡單性**：協同式多工的實現通常比搶佔式多工簡單，因為不需要考慮複雜的上下文切換與優先級。
- **低開銷**：切換開銷較低，因為沒有額外的中斷或搶佔。

不過，它也有以下缺點：

- **不穩定性**：若某個任務沒有主動讓渡控制權，可能會導致其他任務無法執行。
- **無法應對緊急事件**：如果任務長時間執行而不讓渡，系統可能無法快速響應外部事件。

##### 總結

協同式多工是一種簡單有效的多任務處理方法，適合在資源有限的嵌入式系統中使用。通過設計合理的任務管理和調度策略，RISC-V 系統可以有效地實現協同式多工，提高系統的利用效率。在本節中，我們介紹了協同式多工的基本概念、實現步驟以及示例，為進一步構建複雜的嵌入式作業系統奠定了基礎。