### 4.5 使用 Icarus Verilog 進行模擬與驗證

在這一節中，我們將探討如何使用 Icarus Verilog 進行 RISC-V 處理器的模擬與驗證。Icarus Verilog 是一個開源的 Verilog 模擬器，廣泛用於數位電路設計的驗證。通過模擬，我們可以檢查設計的正確性，確保處理器能夠按照預期執行指令。

#### 1. 安裝 Icarus Verilog

在開始之前，您需要先安裝 Icarus Verilog。您可以在其[官方網站](http://iverilog.icarus.com/)下載安裝包，或使用適合您操作系統的包管理工具進行安裝。

例如，在 Ubuntu 上，您可以通過以下命令安裝：

```bash
sudo apt-get install iverilog
```

#### 2. 撰寫測試平台

為了模擬 RISC-V 處理器，您需要撰寫一個測試平台（Testbench），該平台將實例化處理器並提供必要的信號驅動。以下是一個簡單的測試平台示例：

```verilog
module tb_riscv_system;
	reg clk;                      // 時鐘信號
	reg reset;                    // 重置信號
	wire [31:0] result;          // 處理器的輸出

	// 實例化 RISC-V 系統
	riscv_system uut (
		.clk(clk),
		.reset(reset),
		.result(result)
	);

	// 時鐘生成
	initial begin
		clk = 0;                  // 初始時鐘為 0
		forever #5 clk = ~clk;    // 每 5 時間單位反轉一次時鐘
	end

	// 測試序列
	initial begin
		// 重置系統
		reset = 1;
		#10;
		reset = 0;

		// 在此處添加其他測試指令
		// 例如：將指令載入記憶體、檢查結果等
		#100; // 等待一段時間以執行指令

		// 檢查結果
		if (result == expected_value) begin
			$display("Test passed!");
		end else begin
			$display("Test failed! Expected: %d, Got: %d", expected_value, result);
		end

		$finish; // 結束模擬
	end
endmodule
```

#### 3. 執行模擬

在撰寫好測試平台後，您可以使用 Icarus Verilog 進行編譯和模擬。使用以下命令編譯您的 Verilog 檔案：

```bash
iverilog -o riscv_system_tb riscv_system.v tb_riscv_system.v
```

這條命令將 `riscv_system.v` 和 `tb_riscv_system.v` 編譯成一個可執行的檔案 `riscv_system_tb`。

然後運行模擬：

```bash
vvp riscv_system_tb
```

您應該可以看到模擬結果的輸出。

#### 4. 檢查輸出與錯誤診斷

在模擬過程中，您可能會遇到一些問題。以下是一些常見的錯誤診斷方法：

- **訊號不正確**：檢查時鐘和重置信號的驅動是否正確，並確保所有模組都已正確實例化。
- **模擬無法啟動**：確保您的 Verilog 檔案沒有語法錯誤，並且所有依賴的模組都已正確編譯。
- **結果不符**：仔細檢查您的測試向量和預期的結果，確保您正在檢查的邏輯是正確的。

#### 5. 擴展測試

在初步的測試通過後，建議擴展測試的覆蓋範圍。您可以考慮以下幾個方向：

- **邊界條件測試**：測試各種極端情況，如最大和最小值的操作。
- **多種指令組合**：載入多條指令，檢查處理器在執行不同指令時的行為。
- **錯誤處理測試**：模擬錯誤情況，例如非法指令或存取違規。

### 小結

在本節中，我們學習了如何使用 Icarus Verilog 來模擬和驗證我們的 RISC-V 處理器設計。通過撰寫測試平台，編譯模組，以及執行模擬，我們能夠檢查系統的正確性並確保其穩定性。接下來的章節將探討更進一步的主題，如管線化處理器的設計與驗證。