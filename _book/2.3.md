#### 2.3 使用 RISC-V 工具鏈 (GCC、Assembler、Linker、Simulator)

RISC-V 工具鏈是一組用於開發和編譯 RISC-V 程式的工具，這些工具通常包括編譯器、組合語言處理器、鏈接器和模擬器。本節將介紹如何使用這些工具來編寫、編譯、鏈接和模擬 RISC-V 程式。

##### 1. 工具鏈概述

RISC-V 工具鏈主要包括以下組件：

- **GCC（GNU Compiler Collection）**：GNU 開源編譯器套件，支援多種程式語言（如 C、C++ 和 Fortran），並提供 RISC-V 的支援。GCC 能夠將高階語言源代碼編譯成 RISC-V 指令碼。

- **Assembler（組合語言處理器）**：負責將組合語言程式碼轉換成機器碼。對於 RISC-V，常用的組合語言處理器是 `riscv64-unknown-elf-as`，其將 RISC-V 組合語言指令編譯成二進制格式。

- **Linker（鏈接器）**：負責將一個或多個物件檔案結合為一個可執行檔案，並解決程式中不同模組之間的符號引用。對於 RISC-V，通常使用 `riscv64-unknown-elf-ld` 作為鏈接器。

- **Simulator（模擬器）**：用於模擬 RISC-V 硬體，能在不需要實際 RISC-V 處理器的情況下執行程式。常用的模擬器有 QEMU 和 Spike，這些模擬器能夠運行編譯好的 RISC-V 程式，並提供調試和性能分析的功能。

##### 2. 環境設置

要使用 RISC-V 工具鏈，首先需要在系統上安裝相應的工具。以下是安裝工具鏈的基本步驟：

1. **下載 RISC-V 工具鏈**：可以從官方的 RISC-V GitHub 頁面下載預編譯的工具鏈或從源碼編譯。選擇合適的版本（如 RISC-V GCC）並下載。

2. **設置環境變數**：將工具鏈的可執行檔路徑加入到系統環境變數中，以便可以在命令行中直接調用工具。

3. **驗證安裝**：在終端執行 `riscv64-unknown-elf-gcc --version`，檢查 GCC 是否安裝成功。

##### 3. 寫入 RISC-V 程式

一旦工具鏈安裝完成，可以開始編寫 RISC-V 程式。以下是簡單的 RISC-V C 程式範例：

```c
#include <stdio.h>

int main() {
	printf("Hello, RISC-V!\n");
	return 0;
}
```

將以上程式保存為 `hello.c`。

##### 4. 編譯程式

使用 GCC 編譯 RISC-V 程式，執行以下命令：

```bash
riscv64-unknown-elf-gcc -o hello hello.c
```

這條命令將 `hello.c` 編譯成名為 `hello` 的可執行檔案。可以使用 `-O` 選項進行最佳化，或使用 `-march` 指定目標架構。

##### 5. 組合語言程式編譯

對於 RISC-V 組合語言程式，可以將其保存為 `.s` 檔案（如 `hello.s`），內容如下：

```assembly
.section .data
msg:    .asciz "Hello, RISC-V!"

.section .text
.globl main
main:
	li a7, 4            # 系統呼叫號碼 (write)
	la a0, msg          # 載入字串地址
	li a1, 13           # 字串長度
	ecall               # 呼叫操作系統
	li a7, 10           # 系統呼叫號碼 (exit)
	ecall               # 呼叫操作系統
```

使用以下命令組合並編譯該檔案：

```bash
riscv64-unknown-elf-as -o hello.o hello.s
riscv64-unknown-elf-ld -o hello hello.o
```

##### 6. 使用模擬器運行程式

一旦可執行檔案生成，可以使用模擬器運行它。例如，使用 QEMU：

```bash
qemu-riscv64 ./hello
```

這條命令將啟動 QEMU 模擬器並執行 RISC-V 程式，應顯示 "Hello, RISC-V!" 的輸出。

##### 7. 除錯與分析

使用模擬器的除錯功能，可以追蹤程式的執行。若需要更深入的分析，工具鏈還支援多種性能分析工具，能夠收集運行數據，幫助開發者優化程式效能。

#### 總結

使用 RISC-V 工具鏈，開發者可以輕鬆地編寫、編譯、鏈接和模擬 RISC-V 程式。工具鏈的開放性和靈活性，使其在嵌入式系統和高效能計算領域都得到了廣泛的應用。通過本節的介紹，讀者應能掌握基本的 RISC-V 開發流程，並能夠進行簡單的 RISC-V 程式開發。