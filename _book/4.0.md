### 4. 自制單週期的 RISC-V 處理器 (Verilog + Icarus)

在本章中，我們將介紹如何設計和實現一個簡單的單週期 RISC-V 處理器。這個處理器將使用 Verilog 進行硬體描述，並使用 Icarus Verilog 進行模擬和驗證。單週期處理器的設計重點在於每個指令都能在一個時鐘週期內完成，這使得設計相對簡單且易於理解。

#### 1. 單週期處理器的基本概念

單週期處理器的特點是每個指令在一個時鐘週期內完成執行。這意味著指令的取指、解碼、執行及寫回操作都是在同一個時鐘週期內完成。雖然這種設計簡單，但在速度和效率上通常不如多週期或管線化的處理器。

##### 1.1 優缺點

- **優點**：
  - 設計簡單，易於實現和理解。
  - 測試和驗證相對容易。

- **缺點**：
  - 指令執行時間較長，無法有效利用時鐘週期。
  - 無法實現高效能的流水線設計，難以處理高頻率運算。

#### 2. Verilog 基礎與設計流程

Verilog 是一種硬體描述語言（HDL），用於描述數位電路的結構和行為。設計單週期 RISC-V 處理器的過程如下：

##### 2.1 環境設置

確保已安裝 Icarus Verilog 和其他相關工具。可以使用以下命令安裝 Icarus Verilog：

```bash
sudo apt-get install iverilog
```

##### 2.2 編寫 Verilog 代碼

在本專案中，我們將編寫幾個主要的 Verilog 模組：

- **CPU 模組**：整個處理器的核心，負責指令的處理。
- **記憶體模組**：用於儲存指令和數據。
- **ALU（算術邏輯單元）**：執行數學運算和邏輯運算。

#### 3. CPU 模組的 Verilog 實現

以下是單週期 RISC-V 處理器的基本 CPU 模組的 Verilog 代碼：

```verilog
module riscv_cpu (
	input clk,
	input reset,
	output reg [31:0] result
);
	// 定義內部信號
	reg [31:0] instruction;
	reg [31:0] pc;  // 程式計數器
	reg [31:0] regfile [0:31]; // 寄存器檔
	wire [31:0] alu_result;
	
	// ALU 實例
	alu my_alu (
		.a(regfile[rs1]),
		.b(regfile[rs2]),
		.alu_op(instruction[30:25]),
		.result(alu_result)
	);
	
	// 指令取取
	always @(posedge clk or posedge reset) begin
		if (reset) begin
			pc <= 0;
			result <= 0;
		end else begin
			instruction <= mem[pc]; // 取指
			pc <= pc + 1; // 更新程式計數器
			// 執行指令
			regfile[rd] <= alu_result;
			result <= alu_result; // 輸出結果
		end
	end
endmodule
```

#### 4. 加上記憶體形成完整系統

記憶體模組負責儲存指令和數據。我們可以將記憶體模組與 CPU 模組整合在一起，使處理器能夠讀取和寫入數據。

```verilog
module memory (
	input clk,
	input [31:0] addr,
	input [31:0] write_data,
	input we, // 寫使能
	output reg [31:0] read_data
);
	reg [31:0] mem [0:255]; // 簡單的 SRAM
	
	always @(posedge clk) begin
		if (we) begin
			mem[addr] <= write_data; // 寫入數據
		end
		read_data <= mem[addr]; // 讀取數據
	end
endmodule
```

#### 5. 使用 Icarus Verilog 進行模擬與驗證

我們可以使用 Icarus Verilog 來編譯和模擬我們的處理器設計。首先，確保所有的 Verilog 文件都在同一目錄下，然後使用以下命令編譯：

```bash
iverilog -o riscv_cpu_tb.vvp riscv_cpu.v memory.v alu.v
```

然後，使用以下命令執行模擬：

```bash
vvp riscv_cpu_tb.vvp
```

#### 6. mini-riscv-cpu 專案

這個專案將整合以上的模組，並提供一個簡單的測試平台，讓開發者能夠運行基本的 RISC-V 程式。專案的結構如下：

```
mini-riscv-cpu/
├── src/
│   ├── riscv_cpu.v        // CPU 模組
│   ├── memory.v           // 記憶體模組
│   ├── alu.v              // ALU 模組
│   └── tb_riscv_cpu.v     // 測試基準
├── Makefile                // 編譯指令
└── README.md               // 專案說明文件
```

#### 7. 總結

在本章中，我們介紹了如何使用 Verilog 設計一個單週期的 RISC-V 處理器。通過這個過程，讀者能夠了解處理器的基本構造及其工作原理。同時，使用 Icarus Verilog 進行模擬和驗證，使得我們能夠檢查設計的正確性。這是一個良好的開始，為更複雜的多週期或管線化處理器設計奠定基礎。