### 2. RISC-V 的組合語言 (ASM + RISC-V tool chain)

RISC-V 是一個精簡且模組化的指令集架構 (ISA)，為嵌入式系統和高性能應用提供了靈活的支援。RISC-V 的組合語言允許開發者直接操控硬體，充分利用 RISC-V 的指令集特性。透過組合語言，開發者可以精細控制處理器的執行流程、記憶體訪問以及其他低階操作，這對於性能優化和嵌入式系統開發特別重要。

本章將介紹 RISC-V 組合語言的基本概念，以及如何使用 RISC-V 工具鏈來編譯、鏈接和模擬組合語言程式，並探討一些性能最佳化的技巧。

#### 2.1 組合語言的基本概念

組合語言 (Assembly Language) 是一種低階編程語言，直接對應於處理器指令集。每條組合語言指令通常會直接映射為一條機器指令，從而允許開發者以更接近硬體的方式編程。

1. **指令與機器語言的對應**：  
   組合語言中的每條指令都對應於一個特定的機器語言操作碼 (opcode)。例如，在 RISC-V 中，`addi` 指令用於執行加法操作，它會轉換為一條特定的機器碼指令。理解這些指令與底層硬體操作之間的對應關係，是高效使用組合語言的基礎。

2. **暫存器與記憶體的操作**：  
   組合語言主要通過操作暫存器和記憶體來完成計算。RISC-V 具有一組通用暫存器 (如 `x0` 到 `x31`)，開發者可以使用這些暫存器進行數據存取和操作。了解如何有效管理暫存器，並與記憶體進行數據交換，是組合語言編程的核心技能。

3. **控制流程**：  
   組合語言通常依賴跳轉指令（如 `jal` 和 `beq` 等）來控制程式的執行流程。這些指令允許程式根據條件或無條件地跳轉到程式的不同位置，從而實現循環、條件分支等基本控制結構。

#### 2.2 RISC-V 指令集架構 (ISA) 概述

RISC-V 的 ISA 被設計成簡單而靈活，允許開發者根據應用需求選擇不同的指令集擴展。本節將概述 RISC-V 的基本指令集和一些常用的擴展。

1. **基本指令集 (RV32I)**：  
   RISC-V 的基本指令集提供了運算指令、記憶體訪問指令、跳轉指令等核心操作。這些指令足以完成大部分的計算任務。例如，`addi` 用於立即數加法，`lw` 和 `sw` 用於讀寫記憶體，`jal` 用於跳轉和連結。

2. **擴展指令集 (如 M、A、F、D)**：  
   根據不同的應用需求，RISC-V 支援多種指令集擴展。例如，M 擴展支援乘法和除法操作，A 擴展提供了原子操作，F 和 D 擴展則支援浮點數操作。這些擴展使得 RISC-V 更加靈活，可以適應從嵌入式系統到高性能運算的不同需求。

3. **特權級指令集**：  
   RISC-V 還包括一組特權級指令，用於作業系統和虛擬機管理程式的開發。這些指令包括中斷處理、記憶體管理和系統呼叫等功能，適用於需要操作硬體層面的系統程式開發。

#### 2.3 使用 RISC-V 工具鏈 (assembler、linker、simulator)

RISC-V 的工具鏈為開發者提供了一整套支援組合語言開發的工具，包括組譯器 (assembler)、鏈接器 (linker) 和模擬器 (simulator)。

1. **組譯器 (Assembler)**：  
   組譯器將組合語言程式轉換為機器語言程式。在 RISC-V 的開發環境中，常用的組譯器是 `riscv32-unknown-elf-as`。開發者可以通過它將 `.s` 檔案組譯成二進制的機器碼，準備執行或模擬。

2. **鏈接器 (Linker)**：  
   鏈接器將多個組譯後的目標檔案 (.o 檔) 組合成一個可執行的程式。在 RISC-V 工具鏈中，`riscv32-unknown-elf-ld` 是常用的鏈接工具。鏈接器的作用是在目標檔案中解決符號，並將不同的程式段（如程式碼段、資料段）組合在一起，生成最終的執行檔案。

3. **模擬器 (Simulator)**：  
   模擬器允許開發者在沒有實體硬體的情況下模擬 RISC-V 程式的執行。常用的模擬器包括 Spike 和 QEMU，它們能夠精確模擬 RISC-V 處理器的行為，幫助開發者除錯和驗證程式。

#### 2.4 撰寫與執行 RISC-V 組合語言程式

在學習如何使用 RISC-V 組合語言時，撰寫和執行實際的程式是必不可少的。本節將介紹如何撰寫一個簡單的 RISC-V 組合語言程式，並在模擬器上執行它。

1. **撰寫簡單的組合語言程式**：  
   組合語言程式通常由一系列指令組成，每條指令負責執行特定的操作。以下是一個簡單的 "Hello World" 組合語言程式範例，它會通過 UART 印出訊息：

   ```assembly
   .section .data
   msg: .asciz "Hello, RISC-V!\n"

   .section .text
   .globl _start
   _start:
       la a0, msg      # 加載訊息的位址
       li a7, 1        # 系統呼叫編號 (1 是打印)
       ecall           # 呼叫系統
       li a7, 10       # 系統呼叫編號 (10 是退出)
       ecall           # 呼叫系統結束程式
   ```

2. **組譯與鏈接程式**：  
   撰寫完成後，可以使用以下命令組譯並鏈接這個程式：

   ```bash
   riscv32-unknown-elf-as -o hello.o hello.s
   riscv32-unknown-elf-ld -o hello hello.o
   ```

3. **模擬程式執行**：  
   可以使用 Spike 或 QEMU 來模擬執行這個程式：

   ```bash
   spike pk hello
   ```

4. **除錯與分析**：  
   通過使用模擬器提供的除錯工具，開發者可以跟蹤程式執行，檢查暫存器值，或分析程式的性能表現。

#### 2.5 效能與最佳化技巧

雖然組合語言程式的可讀性較低，但它允許開發者進行精細的性能優化。通過直接操控暫存器和指令，開發者可以最大化程式的執行效率。本節將介紹一些常用的效能最佳化技巧。

1. **暫存器的有效使用**：  
   減少記憶體訪問次數，盡量使用暫存器來保存中間計算結果，可以大幅提高程式效率。RISC-V 提供了 32 個通用暫存器，開發者應合理分配和使用它們，減少不必要的 `lw` 和 `sw` 操作。

2. **分支預測與循環最佳化**：  
   在程式中使用跳轉

指令和循環時，應避免頻繁的分支失敗。使用簡單的循環結構，並盡量減少條件分支指令的使用，可以提高分支預測的命中率。

3. **內聯組合語言**：  
   在 C 或其他高階語言中內聯組合語言，可以將關鍵的性能敏感部分用組合語言實現，從而提升程式性能。這在一些需要高效處理的場景中非常有用。

#### 總結
RISC-V 的組合語言為開發者提供了直接控制處理器的能力，使其能夠針對特定應用進行低階的優化。本章介紹了 RISC-V 組合語言的基礎知識、工具鏈的使用方法，以及一些性能最佳化技巧。透過組合語言的學習，讀者將能更深入地理解處理器的內部運作，並學會如何開發高效能的低階程式。