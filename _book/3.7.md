### 3.7 mini-riscv-os 專案

在這一節中，我們將介紹一個簡化的 RISC-V 嵌入式作業系統專案，名為 **mini-riscv-os**。這個專案的目標是提供一個基本的作業系統架構，讓使用者能夠了解 RISC-V 系統的運作，並且提供一個實作的平台來練習嵌入式系統的開發。

#### 1. 專案背景

**mini-riscv-os** 專案旨在讓開發者學習如何在 RISC-V 架構上實現一個簡單的作業系統。專案中包含了基本的任務管理、時間管理和簡單的 I/O 操作，適合用於教學和實驗目的。

#### 2. 專案目標

- **任務管理**：實現基本的任務切換和協同式多工。
- **時間管理**：設計時間中斷機制，讓系統能夠在任務之間進行切換。
- **簡單的 I/O 操作**：通過 UART 實現輸出功能，讓使用者能夠在串口上看到作業系統的運作狀態。
- **簡化的架構**：提供清晰的代碼結構，方便開發者理解和修改。

#### 3. 專案架構

專案的主要結構如下：

```
mini-riscv-os/
├── src/
│   ├── main.c              // 系統入口點
│   ├── uart.c              // UART 驅動
│   ├── scheduler.c         // 任務調度
│   ├── context_switch.c     // 上下文切換
│   └── tasks.c             // 任務管理
├── include/
│   ├── uart.h              // UART 標頭檔
│   ├── scheduler.h         // 調度器標頭檔
│   ├── context_switch.h     // 上下文切換標頭檔
│   └── tasks.h             // 任務管理標頭檔
├── Makefile                 // 編譯指令
└── README.md                // 專案說明文件
```

#### 4. 系統核心

##### 4.1 系統入口點 (`main.c`)

系統的入口點是 `main` 函數，負責初始化硬體和啟動第一個任務。

```c
#include "uart.h"
#include "scheduler.h"

void main() {
	uart_init();          // 初始化 UART
	uart_send_string("Hello from mini-riscv-os!\n");

	scheduler_init();     // 初始化調度器
	scheduler_start();     // 開始任務調度
}
```

##### 4.2 UART 驅動 (`uart.c`)

UART 驅動負責初始化串口並提供發送字串的函數。

```c
#include "uart.h"

// UART 初始化
void uart_init() {
	// 設定 UART 控制寄存器
}

// 發送字串
void uart_send_string(const char *str) {
	while (*str) {
		// 發送單個字符
		str++;
	}
}
```

##### 4.3 任務調度 (`scheduler.c`)

調度器負責管理任務的切換，並透過時間中斷來實現可搶先多工。

```c
#include "scheduler.h"
#include "context_switch.h"

static TaskControlBlock *current_task;

void scheduler_init() {
	// 初始化任務控制塊
}

void scheduler_start() {
	// 啟動第一個任務
}

void scheduler_tick() {
	// 生成時間中斷，進行任務切換
	switch_context(current_task, next_task);
}
```

##### 4.4 上下文切換 (`context_switch.c`)

上下文切換模組用於保存和恢復任務的狀態。

```c
#include "context_switch.h"

void switch_context(TaskControlBlock *current, TaskControlBlock *next) {
	// 保存當前任務上下文
	// 切換到下一個任務
	// 恢復下一個任務的上下文
}
```

#### 5. 任務示例

可以在 `tasks.c` 中定義幾個簡單的任務。每個任務是一個獨立的函數，執行一些簡單的操作。

```c
#include "tasks.h"

void task1() {
	while (1) {
		uart_send_string("Task 1 is running...\n");
		// 等待一段時間
	}
}

void task2() {
	while (1) {
		uart_send_string("Task 2 is running...\n");
		// 等待一段時間
	}
}
```

#### 6. 編譯與運行

使用 `Makefile` 文件編譯專案，並將生成的可執行檔在 RISC-V 硬體或模擬器上運行。

```makefile
CC = riscv64-unknown-elf-gcc
CFLAGS = -Wall -O2
SRC = src/main.c src/uart.c src/scheduler.c src/context_switch.c src/tasks.c
OBJ = $(SRC:.c=.o)

all: mini-riscv-os

mini-riscv-os: $(OBJ)
	$(CC) $(CFLAGS) -o mini-riscv-os $(OBJ)

clean:
	rm -f *.o mini-riscv-os
```

#### 7. 總結

**mini-riscv-os** 專案提供了一個簡化的環境，幫助開發者理解 RISC-V 嵌入式作業系統的基本原理和實現。通過該專案，開發者可以深入了解任務管理、時間中斷和上下文切換等重要概念，並在實際開發中進行應用和實驗。這不僅是一個學習工具，也是一個未來擴展和改進的基礎平台。