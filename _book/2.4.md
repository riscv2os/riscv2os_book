#### 2.4 撰寫與執行 RISC-V 組合語言程式

RISC-V 組合語言是一種低階語言，與特定的硬體架構緊密相關，直接反映出指令集的操作。學習撰寫 RISC-V 組合語言程式不僅能幫助理解處理器的運作原理，還能提升對系統底層運作的掌握。以下將介紹如何撰寫、編譯及執行一個簡單的 RISC-V 組合語言程式。

##### 1. RISC-V 組合語言基礎

在撰寫 RISC-V 組合語言程式之前，先了解一些基本概念：

- **指令格式**：RISC-V 指令有多種格式，包括 R 型、I 型、S 型、B 型、U 型和 J 型，這些格式決定了操作數的編碼方式。

- **註解**：使用 `#` 符號來添加註解，註解將被組合語言處理器忽略，用於增加程式的可讀性。

- **標籤**：可以在程式中使用標籤（如 `loop:`），用於指示指令的跳轉位置。

##### 2. 撰寫組合語言程式

以下是撰寫 RISC-V 組合語言程式的步驟。這個範例程式將計算兩個數的和並輸出結果。

```assembly
.section .data
msg: .asciz "Result: %d\n"   # 儲存輸出的字串

.section .text
.globl main
main:
    # 將數字 5 和 10 加入到暫存器中
    li a0, 5                 # 將數字 5 載入到 a0
    li a1, 10                # 將數字 10 載入到 a1

    # 計算和
    add a2, a0, a1           # 將 a0 和 a1 相加，結果存到 a2

    # 輸出結果
    li a7, 1                 # 系統呼叫號碼 (print_int)
    mv a0, a2                # 將結果載入到 a0
    ecall                    # 呼叫操作系統

    # 結束程式
    li a7, 10                # 系統呼叫號碼 (exit)
    ecall                    # 呼叫操作系統
```

##### 3. 保存與編譯程式

將上述程式保存為 `sum.s` 檔案。接著，使用 RISC-V 工具鏈進行組合與編譯：

1. **組合**：將組合語言程式轉換為物件檔案。

   ```bash
   riscv64-unknown-elf-as -o sum.o sum.s
   ```

2. **鏈接**：將物件檔案鏈接成可執行檔案。

   ```bash
   riscv64-unknown-elf-ld -o sum sum.o
   ```

##### 4. 使用模擬器執行程式

可使用模擬器運行編譯好的可執行檔案。以下示範如何使用 QEMU 執行程式：

```bash
qemu-riscv64 ./sum
```

執行後，應該能看到以下輸出：

```
Result: 15
```

##### 5. 除錯與分析

若程式未按預期運行，可以使用 RISC-V 模擬器的除錯功能來追蹤問題。也可以使用 `gdb` 等工具來進行除錯，檢查暫存器的值和程式執行的流程。

##### 總結

本節介紹了如何撰寫和執行一個簡單的 RISC-V 組合語言程式，並展示了基本的運算與輸出。透過這些實作，讀者應能理解組合語言的結構和運作原理，並能進一步探索更複雜的 RISC-V 程式設計。