### 3. 自制嵌入式 RISC-V 作業系統 (C + ASM)

在本章中，我們將探討如何構建一個自制的嵌入式 RISC-V 作業系統。嵌入式作業系統專為特定應用設計，通常在資源受限的環境中運行。因此，我們的系統將注重效能、可靠性和輕量化。整個過程包括系統架構設計、基本組件的實現及測試。以下是本章的具體內容。

#### 3.1 嵌入式作業系統的基本結構

嵌入式作業系統的基本結構通常包括以下幾個主要組件：

- **核心 (Kernel)**：管理硬體資源，包括處理器、記憶體、I/O 設備等。核心是作業系統的核心部分，負責任務的調度和資源分配。

- **驅動程式 (Device Drivers)**：與硬體交互的軟體層，為操作系統提供硬體控制和管理的功能。

- **系統呼叫 (System Calls)**：提供應用程式與核心之間的接口，允許應用程式請求操作系統的服務。

- **任務管理 (Task Management)**：負責任務的創建、終止和切換，支持多任務操作。

#### 3.2 在裸機上面透過 UART 印出 Hello

我們將首先設置一個基本的環境，通過 UART 輸出 "Hello, World!" 來確認系統正常運行。這需要配置 UART 設備並實現基本的輸出功能。

```c
// uart.c
#include <stdint.h>

#define UART_BASE 0x10000000  // 假設的 UART 基地址
#define UART_TXDATA (UART_BASE + 0x00)  // 發送數據寄存器

void uart_init() {
	// 初始化 UART 設備 (可選)
}

void uart_putc(char c) {
	while (*((volatile uint32_t*)UART_TXDATA) & 0x80000000); // 等待傳輸完成
	*((volatile uint32_t*)UART_TXDATA) = c; // 發送字符
}

void uart_puts(const char *s) {
	while (*s) {
		uart_putc(*s++);
	}
}

int main() {
	uart_init();  // 初始化 UART
	uart_puts("Hello, World!\n");  // 輸出信息
	while (1);  // 無限循環
}
```

#### 3.3 內文切換

內文切換是支持多任務的重要功能。這需要將當前任務的上下文（即暫存器狀態）保存，然後加載新任務的上下文。以下是簡單的上下文切換實現。

```c
typedef struct {
	uint32_t sp;  // 堆疊指針
	uint32_t ra;  // 返回地址
	// 其他暫存器...
} task_t;

task_t current_task, next_task;  // 當前任務和下一任務

void context_switch() {
	asm volatile (
		"sw ra, 0(sp)\n"       // 保存返回地址
		"sw sp, 4(sp)\n"      // 保存堆疊指針
		"la sp, next_task.sp\n" // 載入下一任務的堆疊指針
		"lw ra, 0(sp)\n"      // 恢復返回地址
		"lw sp, 4(sp)\n"      // 恢復堆疊指針
		"ret\n"               // 返回
	);
}
```

#### 3.4 協同式多工系統

協同式多工系統允許任務在指定的時間片內運行，然後主動讓出控制權。這要求任務在適當的時機呼叫調度程序。

```c
void yield() {
	context_switch();  // 切換到下一個任務
}
```

#### 3.5 時間中斷的處理

時間中斷是實現時間分配的關鍵。當系統時鐘發生中斷時，必須保存當前任務的上下文，並調度下一個任務。

```c
void timer_interrupt_handler() {
	// 保存當前任務上下文
	context_switch();
	// 設置下一次中斷
}
```

#### 3.6 可搶先多工系統

可搶先多工系統能夠根據優先級中斷任務，這需要額外的資源管理和調度算法。一般來說，使用優先級調度算法能提高系統的效率和響應速度。

```c
void preemptive_scheduler() {
	// 檢查高優先級任務
	// 根據優先級進行調度
}
```

#### 3.7 mini-riscv-os 專案

本節將介紹一個簡單的 mini-riscv-os 專案。此專案將涵蓋基本的作業系統功能，如任務管理、時間管理和 I/O 操作。專案將採用 C 和組合語言混合開發，方便在 RISC-V 平台上運行。

```bash
# 假設的編譯指令
riscv64-unknown-elf-gcc -o mini-riscv-os main.c uart.c -T linker.ld
```

#### 總結

在本章中，我們探討了自制嵌入式 RISC-V 作業系統的設計與實現。從核心結構、基本功能到可搶先多工系統，我們逐步建立了一個簡單而實用的嵌入式作業系統。這一過程不僅增進了對作業系統設計的理解，也提供了實際開發經驗，為後續的系統擴展和優化奠定了基礎。