#### 3.2 在裸機上面透過 UART 印出 Hello

在嵌入式系統開發中，透過 UART（通用非同步收發器）進行數據傳輸是一種常見的方式。這一節將介紹如何在裸機環境下使用 RISC-V 進行 UART 通信，以在串行端口上打印出 "Hello" 字串。這個過程不依賴於任何操作系統，而是直接使用硬體寄存器進行控制。

##### 1. 硬體準備

在開始之前，確保您的開發環境中已經配置好 RISC-V 硬體，並且您的開發板具有 UART 功能。常見的開發板如 SiFive 或其他 RISC-V 開發板通常都支持 UART。

##### 2. UART 的工作原理

UART 是一種串行通信協議，通常由以下幾個組件組成：

- **數據寄存器**：用於發送和接收數據。
- **控制寄存器**：配置 UART 的參數，如波特率、數據位元、停止位元等。
- **狀態寄存器**：指示 UART 的當前狀態，例如發送或接收是否完成。

在這個示例中，我們將設置 UART 以便於將數據發送到終端。

##### 3. 寄存器定義

假設我們的 UART 寄存器位於特定的地址，例如 `0x10000000`。以下是一些寄存器的定義：

- `UART_BASE`：UART 基地址。
- `UART_TXDATA`：數據寄存器，寫入數據時將其發送出去。
- `UART_TXCTRL`：控制寄存器，用於設置發送參數。
- `UART_TXFIFO_FULL`：指示傳輸 FIFO 是否滿的標誌。

```c
#define UART_BASE 0x10000000
#define UART_TXDATA (*(volatile unsigned int *)(UART_BASE + 0x00))
#define UART_TXCTRL (*(volatile unsigned int *)(UART_BASE + 0x04))
#define UART_TXFIFO_FULL (1 << 0)
```

##### 4. 初始化 UART

在開始發送數據之前，需要初始化 UART。這通常包括設置波特率和配置數據格式。在這裡，我們假設 UART 已經預設為 115200 波特率、8 位數據、無奇偶校驗和 1 位停止位。

```c
void uart_init() {
    // 假設這裡不需要做任何特殊的初始化
    UART_TXCTRL = 0x03;  // 設置 8 位數據，無奇偶校驗，1 位停止位
}
```

##### 5. 寫入 UART

接下來，我們需要一個函數來將單個字符發送到 UART。這個函數將檢查發送 FIFO 是否滿，然後將字符寫入數據寄存器。

```c
void uart_send_char(char c) {
    while (UART_TXFIFO_FULL); // 等待發送 FIFO 不滿
    UART_TXDATA = c;          // 發送字符
}
```

##### 6. 寫入字串

接著，我們需要一個函數來發送字符串。這個函數將調用 `uart_send_char` 函數來發送每個字符，直到字符串結束。

```c
void uart_send_string(const char *str) {
    while (*str) {
        uart_send_char(*str++); // 發送每個字符
    }
}
```

##### 7. 主函數

最後，在主函數中，我們將初始化 UART，然後打印出 "Hello" 字串。

```c
int main() {
    uart_init();                     // 初始化 UART
    uart_send_string("Hello\n");     // 發送 "Hello" 字串
    while (1);                       // 保持主循環
    return 0;                       // 理論上不會到達這裡
}
```

##### 總結

在這一節中，我們學會了如何在裸機環境下使用 RISC-V 和 UART 進行串行通信。透過直接操作硬體寄存器，我們能夠在串行端口上打印出 "Hello" 字串。這種方法在開發嵌入式系統和硬體驅動時非常重要，因為它提供了對底層硬體的直接控制。